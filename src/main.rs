#![allow(dead_code, mutable_transmutes, non_camel_case_types, non_snake_case,
         non_upper_case_globals, unused_assignments, unused_mut)]
#![feature(const_raw_ptr_to_usize_cast, extern_types, main)]

mod sha3;
mod round5;
mod utils;

use rustc_serialize::hex::{FromHex,ToHex};

fn main() {
    let keygen_coins = "7C9935A0B07694AA0C6D10E4DB6B1ADD2FD81A25CCB148032DCD739936737F2D8626ED79D451140800E03B59B956F8210E556067407D13DC90FA9E8B872BFB8F147C03F7A5BEBBA406C8FAE1874D7F13C80EFE79A3A9A874CC09FE76F6997615".from_hex().unwrap();

    let mut pk = vec![0; round5::PUBLICKEYBYTES];
    let mut sk = vec![0; round5::SECRETKEYBYTES];

    unsafe {
    round5::crypto_encrypt_keypair(pk.as_mut_ptr(), sk.as_mut_ptr(),
                                   keygen_coins.as_ptr());
    }

    assert_eq!(pk.to_hex(), "7c9935a0b07694aa0c6d10e4db6b1add2fd81a25ccb148032dcd739936737f2d17005777975fe4ea1348cd4dfd79322f34724cdfdf6f1c116de492014157400b0141809b00d547cff0d397d3890b9cee2694f7d354d16128c1df883c25b786b887d9569c9af62006cabfb8a0656f43c323526e0984fbcdbb01175e60c7f5a4b25f3aa2d16a152fbacbe3e8f6d2b006c087136740cb2d3741500bf77f7fab680f36cced8f2826fd789a0f7b7c97dc45be0c0c49225772a87efa830c4d1d1ae55166dd83971ae5a10c97197c96db51bf7adfa75c4e61d58f8e32cab9e2693dc3eeb04e7cd96bd464af8d854440502fa122a04c5f9264316c10bff8ba3016a9ed32ecaf96c4b0be9f0b32ece3ce93026b812207b11daea92647f1ac589e5b42d04d6cd7f2ec1f5fdacf40f22c72448e88d2a9141fa1ac883353ae491c4545921824fbf4bb0e6e4cf407a3a82c2cbbee31121ea89ea5143a4b1f5c2edffbac2c3d70e83d7bfec0cd15a519340b30a71090c12c2b9b1ecde94501facb340547126fb2f36e61a42bed1da000c29a782ec5f55fb435c2b2287d6c57e73f26f101348b87d915746a526821fae0927fdb6e4dbdd4427d1c65818bb0c042b21b0f4dc72d612259dc3e345de0da30a44a413c8a6a99fb956da750eee9137d214e80a5ed34411469f7bd4310299ff2c662014d53b17c07a8ccc96ae5cc3c51212fc72ef233d5e9f739e53063d0741a3ee9e98bd25b5af59b959bb8f0fe69c30b2a6cfafddbda70794393b1312cc80e5e3413d76ebcfeaba2df855228cdc7e3bd4d008418a175b49e5aadb1d815707c49f4e8e770bbaa35943acbb534763c7c16d2530fc25286b576784d90e17a9ef5c7bb6696144a224f3f07c4f72ae17e031e473b4f24381496d43a319da83553ee042d8c3cd048c1bb95010022c0af4a566583fde93073992f4309b55138c47cff27bb228b86e320dfc35fcb8c0ce3e067c0ddbb789dfa99a61bb74c8cfd5c8d84e3b96dd817f8ea882e60f12c7711a4fdc0198bfea9be643b28af4be4baf6b48b2fce7793b94dcdbaabbb5baffbef52964a71a115ef89aae11990de7b449068cbe541126de0f643ef6b5587dec43736483fbda9252971f04cc3967ecf396bc600aa6c06e0c060dd5585608ce5fa7fce3a4c68a06f87dba8697e2f61054f2152914514f2c1dfab2ac05474185fac07b7fb30e3b93126e4074329a80c09d9b06388d487ab0336a9e68b945284bdfae370b36f82426874721467d13403d726fdc7c0fb17e1a4d47f4b9e5920bf401fd40dbd6832637e028d3aaae5ac84782356350910cd465315a4a8c50983415ac53c731eeba8222d05f3e03ef4ca829cdf8b33fad0a5aca1b891727207f8dce6625fba6a0e06d4fb4e2094afccfb369038edfa9bebae3935b65c3bf2b4d10c0161c8f21e1651bdb5d199401975ddcd72620cb3c1600823a8022358b94fe987da07908ef1dfe5fd166e4866888ce9b3c962de3180903f23869928f9b15f6680ccfd3a9837587202e9f25f0c46076a00e811d10f4ebb6cd932f847edacfe61a3252ea01f8a9d1155a9a7cb1ebe8834477202ed40ef0ebfcb4ad48203736b96d440c4a9557018bf99ae16331d16e2d7c553a04e4591e631d012d58710b171a73d4a1dbd780332cf5ae6446b69701c18656643b7ebae2249b48912399867ac9e12b00b4c64221aa869deb072caea4ee2807a8e6221222cc1d5871652c8a3a3e31f218055e22512f7fd61e8e6fa94436063966b9691ada5bb40bdb3aec2c7f15f8c31c97bc0dd23f1107a79336d395ca26b3bc57e7ceab090e82875ac82e9a6897a2bfa4257764f5c4c184b6ecab56ac712c2e97037ea0050b2e8d3d0898ed891c51e3b353a7b1f57b58b93c8bb1a184dd900");

    assert_eq!(sk.to_hex(), "8626ed79d451140800e03b59b956f8210e556067407d13dc90fa9e8b872bfb8f147c03f7a5bebba406c8fae1874d7f13c80efe79a3a9a874cc09fe76f69976157c9935a0b07694aa0c6d10e4db6b1add2fd81a25ccb148032dcd739936737f2d17005777975fe4ea1348cd4dfd79322f34724cdfdf6f1c116de492014157400b0141809b00d547cff0d397d3890b9cee2694f7d354d16128c1df883c25b786b887d9569c9af62006cabfb8a0656f43c323526e0984fbcdbb01175e60c7f5a4b25f3aa2d16a152fbacbe3e8f6d2b006c087136740cb2d3741500bf77f7fab680f36cced8f2826fd789a0f7b7c97dc45be0c0c49225772a87efa830c4d1d1ae55166dd83971ae5a10c97197c96db51bf7adfa75c4e61d58f8e32cab9e2693dc3eeb04e7cd96bd464af8d854440502fa122a04c5f9264316c10bff8ba3016a9ed32ecaf96c4b0be9f0b32ece3ce93026b812207b11daea92647f1ac589e5b42d04d6cd7f2ec1f5fdacf40f22c72448e88d2a9141fa1ac883353ae491c4545921824fbf4bb0e6e4cf407a3a82c2cbbee31121ea89ea5143a4b1f5c2edffbac2c3d70e83d7bfec0cd15a519340b30a71090c12c2b9b1ecde94501facb340547126fb2f36e61a42bed1da000c29a782ec5f55fb435c2b2287d6c57e73f26f101348b87d915746a526821fae0927fdb6e4dbdd4427d1c65818bb0c042b21b0f4dc72d612259dc3e345de0da30a44a413c8a6a99fb956da750eee9137d214e80a5ed34411469f7bd4310299ff2c662014d53b17c07a8ccc96ae5cc3c51212fc72ef233d5e9f739e53063d0741a3ee9e98bd25b5af59b959bb8f0fe69c30b2a6cfafddbda70794393b1312cc80e5e3413d76ebcfeaba2df855228cdc7e3bd4d008418a175b49e5aadb1d815707c49f4e8e770bbaa35943acbb534763c7c16d2530fc25286b576784d90e17a9ef5c7bb6696144a224f3f07c4f72ae17e031e473b4f24381496d43a319da83553ee042d8c3cd048c1bb95010022c0af4a566583fde93073992f4309b55138c47cff27bb228b86e320dfc35fcb8c0ce3e067c0ddbb789dfa99a61bb74c8cfd5c8d84e3b96dd817f8ea882e60f12c7711a4fdc0198bfea9be643b28af4be4baf6b48b2fce7793b94dcdbaabbb5baffbef52964a71a115ef89aae11990de7b449068cbe541126de0f643ef6b5587dec43736483fbda9252971f04cc3967ecf396bc600aa6c06e0c060dd5585608ce5fa7fce3a4c68a06f87dba8697e2f61054f2152914514f2c1dfab2ac05474185fac07b7fb30e3b93126e4074329a80c09d9b06388d487ab0336a9e68b945284bdfae370b36f82426874721467d13403d726fdc7c0fb17e1a4d47f4b9e5920bf401fd40dbd6832637e028d3aaae5ac84782356350910cd465315a4a8c50983415ac53c731eeba8222d05f3e03ef4ca829cdf8b33fad0a5aca1b891727207f8dce6625fba6a0e06d4fb4e2094afccfb369038edfa9bebae3935b65c3bf2b4d10c0161c8f21e1651bdb5d199401975ddcd72620cb3c1600823a8022358b94fe987da07908ef1dfe5fd166e4866888ce9b3c962de3180903f23869928f9b15f6680ccfd3a9837587202e9f25f0c46076a00e811d10f4ebb6cd932f847edacfe61a3252ea01f8a9d1155a9a7cb1ebe8834477202ed40ef0ebfcb4ad48203736b96d440c4a9557018bf99ae16331d16e2d7c553a04e4591e631d012d58710b171a73d4a1dbd780332cf5ae6446b69701c18656643b7ebae2249b48912399867ac9e12b00b4c64221aa869deb072caea4ee2807a8e6221222cc1d5871652c8a3a3e31f218055e22512f7fd61e8e6fa94436063966b9691ada5bb40bdb3aec2c7f15f8c31c97bc0dd23f1107a79336d395ca26b3bc57e7ceab090e82875ac82e9a6897a2bfa4257764f5c4c184b6ecab56ac712c2e97037ea0050b2e8d3d0898ed891c51e3b353a7b1f57b58b93c8bb1a184dd900");

    let msg = "D81C4D8D734FCBFBEADE3D3F8A039FAA".from_hex().unwrap();

    let enc_coins = "C82CE050A6DD85FEA63DD0656AF146B1880F91ABC0072C92A9DA1778769C4661".from_hex().unwrap();

    let mut ct = vec![0; 1541];
    unsafe {
        let mut ct_len = ct.len() as u64;
        round5::crypto_encrypt(ct.as_mut_ptr(),
                               &mut ct_len,
                               msg.as_ptr(), msg.len() as u64,
                               pk.as_ptr(),
                               enc_coins.as_ptr());
    }

    assert_eq!(ct.to_hex(), "82629ed264bad7e8a7b6a14615c9619ab190ad262f01846602cc56a7797b3207f60eaf1b7187502891dae09bb37a7be4f270a9d2868be0962b1a2e53b6d92bae54e29fbc386818bb00a7ee3c0632b810ed83c81d1e5ef051e655d31ffa270f4d10f3fffc2d8fc79402ecb5984458655305b04039a496faa89575fbb84ff7a3b35cbb98ee82d6ded0110c923085171e5e77468732b1c731e226485fea0ae06589f2760a5f911f326e787f7976e7611b17ce8ea46cadab09375aaae8436c9d6f91d2e062a81d335bd7bba5fbf4c48ed5a430c1b4a3777d1001fe879e5584eda09e9c56d8bf85d727908f1d565e9558425eb0d211e6232f1eddaac316cf8522ad77199c1c3a352bff584ce213046d7b9f0b7e50efc46f94c4f57503e68d9d6ceffb054ce03c53e5e891275e55bccef34c92860d3bb02316434b08de55e1eb9ebb6d4771f70d0f6ae4c3a85f036a1982c908359753e47ca6c8763061abda50feffff13c3b8a42598e52401fc119e00264b45c624f70f5fcc6226edd3bce5877c5677ddb9339062deaaaf23be6c6b1c14400f289a8f54f5334b44ff4a866b3a07cd447d73ab10cdd725ffd22708bc2ae93cb7fd925635b15512e455817389311fcd73cf728e6d62ff679194243ccbf3b5afa1b8a40f9a6469d87205f51d3b8944cccf28e774561c48e57b012dd5473257f86b4974f099a2604b11414e7f6f8eaf99565676b5e49fa16c1b80b329c7c317f516b0849fa51ea18241ce433cee4ba1eadac1ae97894371fa86f93379bb230af061552fe4819b437e7f2669aaf9976451588931247261cc62c2f6dcb936c38e62c400d4239a025c52c4978ad85404f822b3dc8f053ffa0ab49a7010847b0d9f3e29dca8c2609203522dcb911e92e77961f6a8400812e55f87b206150df93c827a0f354b691c0c2266112f18a227d659eab51e5ae7dc105a37b6d52a940f245b3bd635b9b973f8b7682170ac34c4ebace175ed05f53f91475641107a7dd034d37fa23730dd409cfffe6996616e390ecf35aa9e1c431d8a5ad5ec81aaf43b2330c8f1604e1db2465daccb6b13799846dbbb0bdc26401081d806c68bf8017be79016dadb615f47006664181b27a6fb227bf611d25919bef8fa9b91ba847c486e58753319dd40e993d4db89e43fa14187fa2d24fd726d3358f219bb31ad1c2141af852490e4b1a6576f10f921f70a537a78659a686d4c9992bb19ac5e7d0905dc9237654fa80a38262808ed98c0df68b4f6eff74e6bb39dab8e8b5ec42d7b448d716a1d3854f0f547ad7fda7ad742cb977e72af35f136fb20ac2d3dcd2e5d3901b72d2ed1c5d3f30e96ab948c8686c16fba00afc9531dac450deb8f058abfd113008126f9b77c7723e2d980f47562e5c2662f2573339df3be5f17890b80fb67dccd2c341ea8d13f80c9e197d06d2a6f08f9b948f6bede6e244b5ab75eb7c707b9366b10d09d7371432cd3e428bbc5ad24ca678698dad1ddd08ea67f50f4cc3b2a94796dbe725568d299490c5d30ae87c902a9c51cf6fb1c56bc273b5f982df6ad0fa497b32231a3df8db4296c6e0a78adc88522f8c44b88c7f8a699ebe07abf3b6be04725e21c2bb028d2f99e9b694e2fc2e8484e2cf96420547041e8b97bedc45100581e141407a253e5433b8d9a42015844a884acd6b67dad4fa2be48d589ec51b1abf476bd9d578d4489954d9b204034a40e9bc2ff1d45947bd13d8f78ffdf732d274ce16179cb0a44c80ca56d9c3e617c6d766b443dabd426e6e1327c38ad3b7bd3be982fc8f11ae466e421d5c2f5264e66d304145e9b6ce46631266d6b4fe4b484f2e1e5919b3c47bf8b65f00d34a653443a2dfff400fc543e3e97fc0586c6fceff6589860087c0cdd4d10ed6e7404cb3cdaca5c246d12978e4cb33c262c38b562ecf0c1cc79cf3be4de2a857e5c5848d0b425bd86737574c8270753574cd99b31a73b5bc37c16adf59d501d4d6e3974f0f816cb3f17b1865ff172892e8e794c887950dcfcd5b6a8f97ec33e5092b1dabfa5605fad2712c172707fbed2aab4c86dd19f53deae38d116b956198f3b83462f3fa6f35c08d7af40ca2c54ec66e608ff02a53fb824701d024911a16403317acf02fb582bf42f3fccf049988202e50e7ce112de42db17a23bccdebb1e1a6a9fa76c8df5345d");

    let mut recovered = vec![0; 4096];
    unsafe {

        let mut m_len = recovered.len() as u64;

        round5::crypto_encrypt_open(recovered.as_mut_ptr(), &mut m_len,
                                    ct.as_ptr(), ct.len() as u64,
                                    sk.as_ptr());

        recovered.truncate(m_len as usize);
    }

    assert_eq!(recovered.to_hex(), msg.to_hex());
    println!("hi");
}
